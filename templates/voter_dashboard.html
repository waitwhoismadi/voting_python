{% extends "base.html" %}

{% block title %}Voter Dashboard - Electronic Voting System{% endblock %}

{% block content %}
<div class="container">
    <div class="card animate-fadeIn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center;">
        <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">üó≥Ô∏è Student Voting Portal</h1>
        <p>Welcome, {{ current_user.name }}! Your voice matters in shaping our student community.</p>
        <p style="opacity: 0.9; margin-top: 0.5rem;">Student ID: {{ current_user.student_id }}</p>
    </div>

    {% if not active_election or not active_election.is_active %}
        <div class="card" style="text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">‚è∞</div>
            <h2 style="color: #667eea;">No Active Election</h2>
            <p>There is currently no active election. Please check back later or contact your election administrator.</p>
            <div style="margin-top: 2rem;">
                <a href="{{ url_for('view_results') }}" class="btn">View Previous Results</a>
                <a href="{{ url_for('index') }}" class="btn" style="background: #6c757d;">Back to Home</a>
            </div>
        </div>
    {% elif current_user.has_voted %}
        <div class="card" style="text-align: center; background: linear-gradient(135deg, #51cf66 0%, #40c057 100%); color: white;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
            <h2>Thank You for Voting!</h2>
            <p style="font-size: 1.1rem; margin: 1rem 0;">Your vote has been successfully recorded and cannot be changed. Thank you for participating in the democratic process.</p>
            <div style="margin-top: 2rem;">
                <a href="{{ url_for('view_results') }}" class="btn" style="background: white; color: #51cf66; font-weight: 600;">View Live Results</a>
            </div>
        </div>

        <!-- Voting Receipt/Summary -->
        <div class="card">
            <h3 style="color: #667eea; text-align: center; margin-bottom: 1.5rem;">üìù Your Voting Receipt</h3>
            <div style="background: #f8f9fa; padding: 2rem; border-radius: 15px; text-align: center;">
                <div style="margin-bottom: 1rem;">
                    <strong>Election:</strong> {{ active_election.title }}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Voter:</strong> {{ current_user.name }} ({{ current_user.student_id }})
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Vote Cast:</strong> <span id="vote-time">Today</span>
                </div>
                <div style="font-size: 0.9rem; color: #666;">
                    üîí Your vote is secure and anonymous. This receipt confirms your participation.
                </div>
            </div>
        </div>
    {% else %}
        <!-- Active Voting Interface -->
        <div class="card">
            <h3 style="color: #667eea; text-align: center; margin-bottom: 2rem;">{{ active_election.title }}</h3>
            <p style="text-align: center; color: #666; margin-bottom: 2rem;">
                {{ active_election.description or "Please select your preferred candidates for each position. You can only vote once." }}
            </p>
            
            <form id="votingForm">
                {% for position in positions %}
                <div style="background: #f8f9fa; border-radius: 15px; padding: 2rem; margin: 2rem 0;">
                    <h4 style="color: #667eea; text-align: center; margin-bottom: 1.5rem;">
                        {% if position.title == 'President' %}üèõÔ∏è{% elif position.title == 'Vice President' %}‚öñÔ∏è{% elif position.title == 'Secretary' %}üìù{% elif position.title == 'Treasurer' %}üí∞{% else %}üéØ{% endif %}
                        {{ position.title }}
                    </h4>
                    
                    {% if position.description %}
                    <p style="text-align: center; color: #666; margin-bottom: 1.5rem; font-style: italic;">
                        {{ position.description }}
                    </p>
                    {% endif %}
                    
                    <div style="display: grid; gap: 1rem;">
                        {% for nominee in position.nominees %}
                        <div style="border: 2px solid #e9ecef; border-radius: 15px; padding: 1.5rem; cursor: pointer; transition: all 0.3s ease;" 
                             onclick="selectNominee(this, '{{ position.id }}', '{{ nominee.id }}')"
                             data-position="{{ position.id }}" data-nominee="{{ nominee.id }}">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <input type="radio" name="position_{{ position.id }}" value="{{ nominee.id }}" style="transform: scale(1.3);">
                                <div style="flex: 1;">
                                    <h5 style="margin-bottom: 0.5rem; font-size: 1.2rem;">{{ nominee.name }}</h5>
                                    
                                    {% if nominee.partylist %}
                                        <p style="color: {{ nominee.partylist.color }}; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 600;">
                                            {{ nominee.partylist.name }}
                                        </p>
                                    {% endif %}
                                    
                                    {% if nominee.motto %}
                                        <p style="font-style: italic; color: #666; margin-bottom: 0.5rem; border-left: 3px solid #667eea; padding-left: 1rem;">
                                            "{{ nominee.motto }}"
                                        </p>
                                    {% endif %}
                                    
                                    <p style="color: #555; font-size: 0.95rem; line-height: 1.5;">
                                        {{ nominee.description }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if not position.nominees %}
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üìã</div>
                            <p>No candidates have been nominated for this position yet.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                
                {% if positions %}
                <div style="text-align: center; margin: 3rem 0;">
                    <div style="background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                        <h4 style="color: #667eea; margin-bottom: 1rem;">Ready to Submit Your Vote?</h4>
                        <p style="color: #666; margin-bottom: 2rem;">
                            Please review your selections above. Once submitted, your vote cannot be changed.
                        </p>
                        <button type="button" class="btn" onclick="submitVote()" id="submitBtn"
                                style="font-size: 1.3rem; padding: 1.2rem 3rem; background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);">
                            üó≥Ô∏è Submit My Vote
                        </button>
                    </div>
                </div>
                {% endif %}
            </form>
        </div>

        {% if not positions %}
        <div class="card" style="text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üìã</div>
            <h3 style="color: #667eea;">No Positions Configured</h3>
            <p>The election administrator has not yet configured the positions for this election.</p>
        </div>
        {% endif %}

        <!-- Voting Help -->
        <div class="card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white;">
            <h4 style="margin-bottom: 1rem;">‚ÑπÔ∏è How to Vote</h4>
            <ol style="padding-left: 1.5rem;">
                <li style="margin-bottom: 0.5rem;">Review each candidate's profile and platform carefully</li>
                <li style="margin-bottom: 0.5rem;">Click on a candidate card to select your choice for each position</li>
                <li style="margin-bottom: 0.5rem;">You can change your selection before submitting</li>
                <li style="margin-bottom: 0.5rem;">Click "Submit My Vote" when you're ready to finalize your choices</li>
                <li>Your vote will be recorded securely and cannot be changed after submission</li>
            </ol>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedVotes = {};

function selectNominee(card, positionId, nomineeId) {
    // Remove selection from other cards in the same position
    const positionCards = document.querySelectorAll(`div[data-position="${positionId}"]`);
    positionCards.forEach(c => {
        c.style.borderColor = '#e9ecef';
        c.style.background = 'white';
        const radio = c.querySelector('input[type="radio"]');
        radio.checked = false;
    });
    
    // Select this card
    card.style.borderColor = '#667eea';
    card.style.background = 'rgba(102, 126, 234, 0.05)';
    card.style.transform = 'translateY(-2px)';
    card.style.boxShadow = '0 10px 25px rgba(102, 126, 234, 0.15)';
    
    const radio = card.querySelector('input[type="radio"]');
    radio.checked = true;
    
    selectedVotes[positionId] = nomineeId;
    
    // Update submit button state
    updateSubmitButton();
}

function updateSubmitButton() {
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        const hasSelections = Object.keys(selectedVotes).length > 0;
        submitBtn.style.opacity = hasSelections ? '1' : '0.6';
        submitBtn.disabled = !hasSelections;
    }
}

function submitVote() {
    if (Object.keys(selectedVotes).length === 0) {
        alert('Please select at least one candidate before submitting your vote.');
        return;
    }

    // Create confirmation message
    const confirmMessage = 'You are about to submit your vote. This action cannot be undone.\n\nAre you sure you want to proceed?';
    
    if (confirm(confirmMessage)) {
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '‚è≥ Submitting Vote...';
        submitBtn.disabled = true;

        fetch('/vote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ votes: selectedVotes })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('üéâ Vote submitted successfully! Thank you for participating.');
                location.reload();
            } else {
                alert('‚ùå Error submitting vote: ' + data.message);
                submitBtn.innerHTML = 'üó≥Ô∏è Submit My Vote';
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            alert('‚ùå Network error occurred. Please try again.');
            submitBtn.innerHTML = 'üó≥Ô∏è Submit My Vote';
            submitBtn.disabled = false;
        });
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set vote time if already voted
    const voteTimeElement = document.getElementById('vote-time');
    if (voteTimeElement) {
        voteTimeElement.textContent = new Date().toLocaleDateString() + ' at ' + new Date().toLocaleTimeString();
    }

    // Add animation to nominee cards
    const cards = document.querySelectorAll('[data-nominee]');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });

    // Initially hide cards for animation
    cards.forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'all 0.5s ease';
    });
});
</script>
{% endblock %}