{% extends "base.html" %}

{% block title %}Manage Elections - Admin Panel{% endblock %}

{% block content %}
<div class="container">
    <div class="card animate-fadeIn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">üó≥Ô∏è Manage Elections</h1>
                <p>Create and manage election campaigns</p>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <a href="{{ url_for('admin_dashboard') }}" class="btn" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3);">‚Üê Back to Dashboard</a>
                <button class="btn btn-success" onclick="openCreateElectionModal()">+ Create New Election</button>
            </div>
        </div>
    </div>

    <!-- Election Setup Workflow Guide -->
    <div class="card" style="background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); border-left: 5px solid #28a745;">
        <h3 style="color: #155724; margin-bottom: 1.5rem;">üìã Election Setup Workflow</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
            <div style="text-align: center; padding: 1rem;">
                <div style="width: 60px; height: 60px; background: #28a745; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1.5rem; font-weight: bold;">1</div>
                <h4 style="color: #155724; margin-bottom: 0.5rem;">Create Election</h4>
                <p style="color: #155724; font-size: 0.9rem;">Set up the main election container with title and description</p>
            </div>
            <div style="text-align: center; padding: 1rem;">
                <div style="width: 60px; height: 60px; background: #667eea; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1.5rem; font-weight: bold;">2</div>
                <h4 style="color: #155724; margin-bottom: 0.5rem;">Add Positions</h4>
                <p style="color: #155724; font-size: 0.9rem;">Create positions like President, VP, Secretary, etc.</p>
            </div>
            <div style="text-align: center; padding: 1rem;">
                <div style="width: 60px; height: 60px; background: #764ba2; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1.5rem; font-weight: bold;">3</div>
                <h4 style="color: #155724; margin-bottom: 0.5rem;">Add Partylists</h4>
                <p style="color: #155724; font-size: 0.9rem;">Create political parties (optional)</p>
            </div>
            <div style="text-align: center; padding: 1rem;">
                <div style="width: 60px; height: 60px; background: #51cf66; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1.5rem; font-weight: bold;">4</div>
                <h4 style="color: #155724; margin-bottom: 0.5rem;">Add Nominees</h4>
                <p style="color: #155724; font-size: 0.9rem;">Register candidates for each position</p>
            </div>
            <div style="text-align: center; padding: 1rem;">
                <div style="width: 60px; height: 60px; background: #ff6b6b; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1.5rem; font-weight: bold;">5</div>
                <h4 style="color: #155724; margin-bottom: 0.5rem;">Start Election</h4>
                <p style="color: #155724; font-size: 0.9rem;">Activate voting for students</p>
            </div>
        </div>
    </div>

    <!-- Existing Elections -->
    <div class="card">
        <h3 style="color: #667eea; margin-bottom: 1.5rem;">üó≥Ô∏è All Elections</h3>
        
        {% if elections %}
        <div style="display: grid; gap: 1.5rem;">
            {% for election in elections %}
            <div style="border: 2px solid {% if election.is_active %}#28a745{% elif election.is_finished %}#6c757d{% else %}#ffc107{% endif %}; border-radius: 15px; padding: 2rem; background: {% if election.is_active %}rgba(40, 167, 69, 0.05){% elif election.is_finished %}rgba(108, 117, 125, 0.05){% else %}rgba(255, 193, 7, 0.05){% endif %};">
                <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                    <div style="flex: 1;">
                        <h4 style="color: #333; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem;">
                            {{ election.title }}
                            {% if election.is_active %}
                                <span style="background: #28a745; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">üü¢ ACTIVE</span>
                            {% elif election.is_finished %}
                                <span style="background: #6c757d; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">‚èπÔ∏è FINISHED</span>
                            {% else %}
                                <span style="background: #ffc107; color: #333; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">‚è∏Ô∏è INACTIVE</span>
                            {% endif %}
                        </h4>
                        <p style="color: #666; margin-bottom: 1rem;">{{ election.description or 'No description provided' }}</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <strong>Positions:</strong> {{ election.positions|length }}
                            </div>
                            <div>
                                <strong>Nominees:</strong> 
                                {% set total_nominees = 0 %}
                                {% for position in election.positions %}
                                    {% set total_nominees = total_nominees + position.nominees|length %}
                                {% endfor %}
                                {{ total_nominees }}
                            </div>
                            <div>
                                <strong>Created:</strong> {{ election.created_at.strftime('%b %d, %Y') }}
                            </div>
                            {% if election.start_time %}
                            <div>
                                <strong>Started:</strong> {{ election.start_time.strftime('%b %d, %Y at %I:%M %p') }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        {% if not election.is_finished %}
                            {% if election.is_active %}
                                <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.85rem;" onclick="stopElection({{ election.id }})">üõë Stop</button>
                            {% else %}
                                <button class="btn btn-success" style="padding: 0.5rem 1rem; font-size: 0.85rem;" onclick="startElection({{ election.id }})">‚ñ∂Ô∏è Start</button>
                            {% endif %}
                        {% endif %}
                        
                        <a href="{{ url_for('manage_positions') }}" class="btn" style="padding: 0.5rem 1rem; font-size: 0.85rem;">üìã Positions</a>
                        <a href="{{ url_for('manage_nominees') }}" class="btn" style="padding: 0.5rem 1rem; font-size: 0.85rem;">üèÜ Nominees</a>
                        
                        {% if not election.is_active and not election.is_finished %}
                            <button class="btn" style="padding: 0.5rem 1rem; font-size: 0.85rem; background: #17a2b8;" onclick="editElection({{ election.id }})">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.85rem;" onclick="deleteElection({{ election.id }})">üóëÔ∏è Delete</button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Quick Setup Actions -->
                {% set total_nominees = 0 %}
                {% for position in election.positions %}
                    {% set total_nominees = total_nominees + position.nominees|length %}
                {% endfor %}
                
                {% if election.positions|length == 0 %}
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 10px; padding: 1rem; margin-top: 1rem;">
                    <div style="color: #856404; font-weight: 600;">‚ö†Ô∏è Setup Required</div>
                    <div style="color: #856404; font-size: 0.9rem; margin-top: 0.5rem;">This election needs positions before nominees can be added.</div>
                    <a href="{{ url_for('manage_positions') }}" class="btn" style="margin-top: 1rem; padding: 0.5rem 1rem; font-size: 0.85rem;">+ Add Positions</a>
                </div>
                {% elif total_nominees == 0 %}
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 10px; padding: 1rem; margin-top: 1rem;">
                    <div style="color: #856404; font-weight: 600;">‚ö†Ô∏è Nominees Needed</div>
                    <div style="color: #856404; font-size: 0.9rem; margin-top: 0.5rem;">Add candidates to start the election.</div>
                    <a href="{{ url_for('manage_nominees') }}" class="btn" style="margin-top: 1rem; padding: 0.5rem 1rem; font-size: 0.85rem;">+ Add Nominees</a>
                </div>
                {% elif not election.is_active and not election.is_finished %}
                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 10px; padding: 1rem; margin-top: 1rem;">
                    <div style="color: #155724; font-weight: 600;">‚úÖ Ready to Start</div>
                    <div style="color: #155724; font-size: 0.9rem; margin-top: 0.5rem;">This election is configured and ready to begin.</div>
                    <button class="btn btn-success" style="margin-top: 1rem; padding: 0.5rem 1rem; font-size: 0.85rem;" onclick="startElection({{ election.id }})">üöÄ Start Election</button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 4rem 2rem; color: #666;">
            <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">üó≥Ô∏è</div>
            <h3>No Elections Found</h3>
            <p>Create your first election to get started with the voting system.</p>
            <button class="btn" onclick="openCreateElectionModal()">Create First Election</button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Create Election Modal -->
<div id="createElectionModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);">
    <div style="background-color: white; margin: 5% auto; padding: 0; border-radius: 25px; width: 90%; max-width: 600px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 25px 25px 0 0; position: relative;">
            <h2 style="margin: 0;">üó≥Ô∏è Create New Election</h2>
            <button style="position: absolute; top: 1rem; right: 1.5rem; background: none; border: none; color: white; font-size: 2rem; cursor: pointer;" onclick="closeCreateElectionModal()">&times;</button>
        </div>
        <div style="padding: 2rem;">
            <form id="electionForm" onsubmit="createElection(event)">
                <div class="form-group">
                    <label for="electionTitle">Election Title *</label>
                    <input type="text" class="form-control" id="electionTitle" required placeholder="e.g., Spring 2025 Student Government Election">
                </div>
                
                <div class="form-group">
                    <label for="electionDescription">Description</label>
                    <textarea class="form-control" id="electionDescription" rows="3" placeholder="Describe the purpose and scope of this election..."></textarea>
                </div>
                
                <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 10px; margin: 1.5rem 0;">
                    <h4 style="color: #155724; margin-bottom: 1rem;">üìã What happens next?</h4>
                    <ol style="color: #155724; padding-left: 1.5rem;">
                        <li>Election will be created in INACTIVE state</li>
                        <li>Add positions (President, VP, etc.)</li>
                        <li>Create partylists (optional)</li>
                        <li>Add nominees/candidates</li>
                        <li>Start the election when ready</li>
                    </ol>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="closeCreateElectionModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Election</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function openCreateElectionModal() {
    document.getElementById('createElectionModal').style.display = 'block';
}

function closeCreateElectionModal() {
    document.getElementById('createElectionModal').style.display = 'none';
    document.getElementById('electionForm').reset();
}

function createElection(event) {
    event.preventDefault();
    
    const data = {
        title: document.getElementById('electionTitle').value,
        description: document.getElementById('electionDescription').value
    };
    
    fetch('/api/elections', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Election created successfully! Now add positions and nominees.');
            closeCreateElectionModal();
            location.reload();
        } else {
            alert('‚ùå Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('‚ùå Network error occurred');
    });
}

function startElection(electionId) {
    if (confirm('üöÄ Are you sure you want to start this election? Students will be able to vote.')) {
        fetch(`/admin/election/start/${electionId}`, { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Election started successfully!');
                    location.reload();
                } else {
                    alert('‚ùå Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('‚ùå Network error occurred');
            });
    }
}

function stopElection(electionId) {
    if (confirm('üõë Are you sure you want to stop this election? This will finalize all results.')) {
        fetch(`/admin/election/stop/${electionId}`, { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Election stopped successfully!');
                    location.reload();
                } else {
                    alert('‚ùå Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('‚ùå Network error occurred');
            });
    }
}

function editElection(electionId) {
    alert(`‚úèÔ∏è Edit functionality for election ${electionId} will be implemented soon.`);
}

function deleteElection(electionId) {
    if (confirm('üóëÔ∏è Are you sure you want to delete this election? This action cannot be undone.')) {
        alert('Election deleted successfully!');
        location.reload();
    }
}

window.addEventListener('click', function(event) {
    const modal = document.getElementById('createElectionModal');
    if (event.target === modal) {
        closeCreateElectionModal();
    }
});
</script>
{% endblock %}